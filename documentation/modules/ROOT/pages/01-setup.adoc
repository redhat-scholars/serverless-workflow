= Setup
include::_attributes.adoc[]

There are several ways to develop on OpenShift Serverless Logic:

* *Pure Cloud*: using https://start.kubesmarts.org/[Serverless Logic Web Tools] and OpenShift as the runtime engine.
* *Browser with local runtime*: using https://start.kubesmarts.org/[Serverless Logic Web Tools] and `kn-workflow` command line (which leverages a local container engine, e.g. `podman`, `docker`)
* *Full-fledged local development workstation*: using _Visual Studio Code_ and _Quarkus_.

This tutorial suggests the first option to minimize the workstation preparation work.

== Deploy the supplier microservice

As you progress through this tutorial, you'll find out how to call an external OpenAPI, and the following Quarkus project will provide a simple API to call from within the workflow.

Deployment instructions:

. *Login* in OpenShift from command line.

. *Create* the `swf-shared` project:

+
[.console-input]
[source,bash,subs="+macros,+attributes"]
----
oc new-project swf-shared
----

. *Clone* https://github.com/dmarrazzo/order-swf-tut-svc[this repository].

. *Build and deploy* the application:

+
[.console-input]
[source,bash,subs="+macros,+attributes"]
----
./mvnw install -Pnative -Dquarkus.kubernetes.deploy=true
----

[#local-runtime]
== Local Runtime

`kn-workflow` is a handy tool for deploying your project in OpenShift, but it can also be used to run the workflow locally in a container (so you don't need to configure Java and Quarkus).

Download the latest tar archive suitable for your environment, from the Serverless Logic https://mirror.openshift.com/pub/cgw/serverless-logic/latest/[download mirror] page.

=== Podman Installation and configuration

NOTE: If you have already installed _Docker_ in your environment, or you feel more comfortable with it, feel free to replace Podman with Docker.

Instructions to *install* Podman and *configure* Quarkus (Testcontainer) to rely on it:

[tabs]
====
Fedora::
+
--
Issue the following commands:

[.console-input]
[source,bash,subs="+macros,+attributes"]
----
sudo dnf install -y podman podman-docker
----

Make sure that you have installed the `4.3.1` version or later, issuing `podman --version`:

[.console-output]
[source,bash,subs="+macros,+attributes"]
----
podman version 4.3.1
----

Enable podman socket listener:

[.console-input]
[source,bash,subs="+macros,+attributes"]
----
systemctl --user enable podman.socket --now
----

Configure *Testcontainers* through the following commands: 

[.console-input]
[source,bash,subs="+macros,+attributes"]
----
echo "docker.host = unix:///run/user/$(id -u)/podman/podman.sock" > ~/.testcontainers.properties
----
[.console-input]
[source,bash,subs="+macros,+attributes"]
----
echo "ryuk.container.privileged = true" >>  ~/.testcontainers.properties
----

For more information and troubleshooting refer to https://quarkus.io/guides/podman#linux[]
--
Mac::
+
--
Leverage Homebrew to install *Podman* and its required dependencies:

[.console-input]
[source,bash,subs="+macros,+attributes"]
----
brew install podman
----

Make sure that you have installed the `4.3.1` version or later, issuing `podman --version`:

[.console-output]
[source,bash,subs="+macros,+attributes"]
----
podman version 4.3.1
----

Install podman helper: 

[.console-input]
[source,bash,subs="+macros,+attributes"]
----
sudo /usr/local/Cellar/podman/4.3.1/bin/podman-mac-helper install
----

Create your *Podman* machine, set it to run rootful containers, then start it:

[.console-input]
[source,bash,subs="+macros,+attributes"]
----
podman machine init
----
[.console-input]
[source,bash,subs="+macros,+attributes"]
----
podman machine set --rootful
----
[.console-input]
[source,bash,subs="+macros,+attributes"]
----
podman machine start
----

Configure *Testcontainers* through the following commands: 

[.console-input]
[source,bash,subs="+macros,+attributes"]
----
echo "ryuk.container.privileged = true" >  ~/.testcontainers.properties
----

--
Mac (Apple M1)::
+
--
Leverage Homebrew to install *Podman* and its required dependencies:

[.console-input]
[source,bash,subs="+macros,+attributes"]
----
brew install podman
----

Make sure that you have installed the `4.3.1` version or later, issuing `podman --version`:

[.console-output]
[source,bash,subs="+macros,+attributes"]
----
podman version 4.3.1
----

Install podman helper: 

[.console-input]
[source,bash,subs="+macros,+attributes"]
----
sudo /usr/local/Cellar/podman/4.3.1/bin/podman-mac-helper install
----

Create your *Podman* machine, set it to run rootful containers, then start it:

[.console-input]
[source,bash,subs="+macros,+attributes"]
----
podman machine init
----
[.console-input]
[source,bash,subs="+macros,+attributes"]
----
podman machine set --rootful
----
[.console-input]
[source,bash,subs="+macros,+attributes"]
----
podman machine start
----

Add support for running x86_64-based containers on a Mac with an M1 chip with the following commands

[.console-input]
[source,bash,subs="+macros,+attributes"]
----
podman machine ssh
sudo -i
rpm-ostree install qemu-user-static
systemctl reboot
----

Configure *Testcontainers* through the following commands: 

[.console-input]
[source,bash,subs="+macros,+attributes"]
----
echo "ryuk.container.privileged = true" >  ~/.testcontainers.properties
----

--
Windows::
+
--
Follow this guide for the podman installation: https://github.com/containers/podman/blob/main/docs/tutorials/podman-for-windows.md[]

Make sure that you have installed the `4.3.1` version or later, issuing `podman --version`:

[.console-output]
[source,bash,subs="+macros,+attributes"]
----
podman version 4.3.1
----

Before starting the Podman machine, set it to prefer rootful container execution:

[.console-input]
[source,bash,subs="+macros,+attributes"]
----
podman machine set --rootful
----
--
====

=== Pull the Serverless Workflow devmode image

In order to run and test the Serverless Workflow project locally, you need a container image which is *lauched behind the scene by `kn-workflow`*. 
However, as it's distributed through the official Red Hat registry, you'll need to login before pulling the image.

Find here the instruction on how to create / retrieve your credentials: https://access.redhat.com/RegistryAuthentication[Registry Authentication]

Login to *registry.redhat.io* with your Red Hat credentials;

[.console-input]
[source,bash,subs="+macros,+attributes"]
----
podman login registry.redhat.io
----

Pull the image:
[.console-input]
[source,bash,subs="+macros,+attributes"]
----
podman pull --platform linux/amd64 registry.redhat.io/openshift-serverless-1/logic-swf-devmode-rhel8:1.34.0
----

NOTE: The parameter `--platform linux/amd64` is important when you run it on a Mac with an M1 chip (which has a different processor architecture)


[#prerequisite]
== Prerequisite tools

WARNING: It is recommended that you complete this section using a reliable connection. Avoid doing this part of the lab on a shared connection because of the bandwidth requirements. Also, some tasks will take a long time to download resources.

Here the tools to install:

[cols="4*^,4*.",options="header,+attributes"]
|===
|**Tool**|**Fedora**|**MacOS**|**Windows**

| `git`
| `dnf install -y git`
| https://git-scm.com/download/mac[Download]
| https://git-scm.com/download/win[Download]

| https://code.visualstudio.com/[Visual Studio Code]
| https://code.visualstudio.com/docs/setup/linux#_rhel-fedora-and-centos-based-distributions[Download] or https://code.visualstudio.com/docs/setup/linux#_installing-rpm-package-manually[Install from the provided USB Stick Resources]
| https://code.visualstudio.com/docs/setup/mac[Download]  or *Install from the provided USB Stick Resources*
| https://code.visualstudio.com/docs/setup/windows[Download] or *Install from the provided USB Stick Resources*

| OpenJDK v11
| `dnf install -y java-11-openjdk-devel`
| https://adoptopenjdk.net/[Mac Version Download]
| https://developers.redhat.com/products/openjdk/download[Windows Download]

| `Apache Maven`
| `dnf install -y maven`
| https://archive.apache.org/dist/maven/maven-3/3.8.6/binaries/apache-maven-3.8.6-bin.tar.gz[Download]
| https://archive.apache.org/dist/maven/maven-3/3.8.6/binaries/apache-maven-3.8.6-bin.zip[Download]
|===

[#vscode-extensions]
== Visual Studio Code Extensions

WARNING: The remaining part of this tutorial does not need Visual Studio Code. However, if you prefer to use it, here you'll find some directions.

Launch Visual Studio Code to install the following extensions:

* KIE Serverless Workflow Editor
* Language Support for Java(TM) by Red Hat - only required if you need to write Java code along with Serverless Workflow.
* REST Client (from Huachao Mao) - this is optional but quite useful.

There are 2 ways:

1. Click on the Extensions icon in the Activity Bar on the side of VS Code, search and install.
+
image::extensions-view-icon.png[]

2. Launch VS Code Quick Open (Ctrl+P), paste the following commands, and press enter:

* `ext install kie-group.swf-vscode-extension`
* `ext install vscjava.vscode-java-pack`
* `ext install humao.rest-client`

[#project-start]
== Quarkus project

If you are interested in running the workflow within a Quarkus project: please, select another edition of this tutorial for detailed guidance.

TIP: At the bottom of the navigation bar, there is a drawer to select the tutorial edition.