<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Compensation :: OpenShift Serverless Logic Tutorial</title>
    <link rel="canonical" href="https://redhat-scholars.github.io/serverless-workflow/osl/osl/smart/05-compensation.html">
    <link rel="prev" href="04-longrunning.html">
    <meta name="generator" content="Antora 3.0.0">
    <link rel="stylesheet" href="../../_/css/site.css">
<link rel="icon" href="../../_/img/favicon.ico" type="image/x-icon">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://developers.redhat.com" target="_blank"><img
          src="../../_/img/RHDLogo.svg" height="40px" alt="Red Hat Developer Program"></a>
      <a class="navbar-item" href="https://redhat-scholars.github.io/serverless-workflow/osl">OpenShift Serverless Logic Tutorial</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="#">Books</a>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">CheatSheets</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">CheatSheet A</a>
            <a class="navbar-item" href="#">CheatSheet B</a>
            <a class="navbar-item" href="#">CheatSheet C</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Upcoming Events</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Event A</a>
            <a class="navbar-item" href="#">Event B</a>
            <a class="navbar-item" href="#">Event C</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">More Tutorials</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Tutorial A</a>
            <a class="navbar-item" href="#">Tutorial B</a>
            <a class="navbar-item" href="#">Tutorial C</a>
          </div>
        </div>
        <div class="navbar-item">
          <span class="control">
            <a class="button is-primary" href="#">Download</a>
          </span>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="osl" data-version="smart">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="index.html" class=" query-params-link">OpenShift Serverless Logic Tutorial</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="01-setup.html">1. Setup</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="01-setup.html#local-runtime">Local Runtime</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="01-setup.html#prerequisite">Prerequisite tools</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="01-setup.html#vscode-extensions">Visual Studio Code Extensions</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="01-setup.html#project-start">Clone and build the startup project</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="02-startup-project.html">2. Startup Project</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="02-startup-project.html#basic-workflow">A basic workflow</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="02-startup-project.html#run">Run the workflow</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="02-startup-project.html#inspect">Inspect the workflow execution</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="03-inventory.html">3. Inventory Logic</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="03-inventory.html#usecase">The use case</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="03-inventory.html#inventory">The Inventory Sprint</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="03-inventory.html#test">Test the workflow logic</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="03-inventory.html#call-rest">Call an external REST service</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="03-inventory.html#test-rest">Test the external REST service</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="04-longrunning.html">4. Long Running Workflows</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="04-longrunning.html#waitevent">Wait Event Sprint</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="04-longrunning.html#eventing">Eventing</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="04-longrunning.html#test-events">Test the events</a>
  </li>
</ul>
  </li>
  <li class="nav-item is-current-page" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="05-compensation.html">5. Compensation</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#cancellingevent">Cancelling Event Sprint</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#test-cancel">Test the cancelling event</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#compensation-activities">Compensation Activities Sprint</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#test-compensation">Testing the compensation</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">OpenShift Serverless Logic Tutorial</span>
    <span class="version">smart</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <span class="title">OpenShift Serverless Logic Tutorial</span>
      <ul class="versions">
        <li class="version is-current">
          <a href="index.html">smart</a>
        </li>
        <li class="version">
          <a href="../index.html">master</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="index.html">OpenShift Serverless Logic Tutorial</a></li>
    <li><a href="05-compensation.html">5. Compensation</a></li>
  </ul>
</nav>
<div class="page-versions">
  <button class="version-menu-toggle" title="Show other versions of page">smart</button>
  <div class="version-menu">
    <a class="version is-current" href="05-compensation.html">smart</a>
    <a class="version" href="../05-compensation.html">master</a>
  </div>
</div>
  <div class="edit-this-page"><a href="https://github.com/redhat-scholars/serverless-workflow/edit/smart/documentation/modules/ROOT/pages/05-compensation.adoc">Edit this Page</a></div>
  </div>
  <div class="content">
<article class="doc">
<h1 class="page">Compensation</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p><strong>Sometimes the unexpected happens</strong>: for example, a customer changes his mind and wants to cancel an order or the stock are running low. Actually, in real world: <em>the change is the only constant!</em></p>
</div>
<div class="paragraph">
<p>Workflow developers start defining the <em>happy path</em>, then they have to deal with unexpected results (out of stock, order cancellation events, etc). A workflow could define a long chain of activities and under certain conditions, it might be necessary to define an exit strategy: warning all parties involved that they <strong>must undo</strong> what has been done before.</p>
</div>
<div class="paragraph">
<p>When you have <strong><em>short running transactions</em></strong> (during milliseconds), you could aspire to the convenient <strong>atomic transaction</strong>, but as long as your tasks span over multiple systems this option brings so many drawbacks which make it unrealistic, especially when they run in a cloud context. In fact, in the microservices architecture, the <a href="https://microservices.io/patterns/data/saga.html:">Saga Pattern</a> is a well know practice when dealing with a cancellation.</p>
</div>
<div class="paragraph">
<p>When you deal with <strong><em>long running transactions</em></strong>, as known as <em>business transactions</em>, that spans of over minutes, hours or days, the <span class="underline">only option available</span> is to revert what was done previously, this could have consequences: for example, Hotels usually applies a cancellation fee when the cancellation is too near to the reservation day.</p>
</div>
<div class="paragraph">
<p>A workflow might involve multiple logical steps, there are conditional paths that depends on specific instance data. When the business logic requires a cancellation of the workflow instance, you need to reverse the flow of actions, undoing what was previously done. In the workflow nomenclature, this capability is called <strong>Compensation</strong>.</p>
</div>
<div class="paragraph">
<p>The good news is that the Serverless Workflow engine helps you in this difficult situations! In fact, the workflow developer can define for each action a <strong>compensation action</strong> that will only be invoked if necessary. Behind the scenes, the workflow engine, when an action is completed, records the corresponding compensation action in a stack. If the workflow subsequently encounters conditions that require compensation, only then does the <strong>engine retrace the stack</strong> of compensation activities to close everything correctly.</p>
</div>
<div class="paragraph">
<p>In short, Serverless Workflow Compensation is very handy whenever dealing with cancellation!</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="cancellingevent"><a class="anchor" href="#cancellingevent"></a>Cancelling Event Sprint</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In our use case, we have to deal with situations where customers have to <strong>cancel their orders</strong>. Specifically, if the cancellation event arrives before the shipping one, it is necessary to call for <strong>compensation</strong>: the concrete compensation action depends on the previous execution path, if the item was available, the compensation action will call the internal shipping department otherwise the compensation action will deal with the external supplier.</p>
</div>
<div class="paragraph">
<p>The following picture shows an high level design:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/high-level-flow-3.png" alt="high level flow 3">
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Given the simplistic nature of the example, one might consider replacing compensation with a gateway followed by compensatory actions. However, it should be borne in mind that in an even slightly more complex flow, implementing compensation in imperative mode would make the implementation complex and error prone.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Below, we will add the definition of the new event type <code>CancelEventType</code> and a forking that distinguishes between the two possible input events:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>shippingEvent</code></p>
</li>
<li>
<p><code>cancelEvent</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Open</strong> the workflow designer:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Inside the event section <strong>add</strong> the <code>cancelEvent</code> declaration:</p>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">- name: cancelEvent
  kind: consumed
  type: CancelEventType
  source: Client
  correlation:
  - contextAttributeName: orderid</code></pre>
</div>
</div>
</li>
<li>
<p>In the state section, <strong>locate</strong> the <code>Order Shipped</code> event state and <strong>overwrite</strong> it with the following snippet:</p>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">- name: Order Shipped or Cancelled
  type: event
  exclusive: true
  onEvents:
  - eventRefs:
    - shippingEvent
  - eventRefs:
    - cancelEvent
    eventDataFilter:
      data: '{cancel:true}'
  transition: Is Shipped?</code></pre>
</div>
</div>
<div class="paragraph">
<p>The new event state definition is able to listen for two different events.
At the cancellation event, we can see the statement <code>eventDataFilter</code> the effect of which is to introduce a new Boolean data: <code>cancel:true</code>. In such a way, we will later be able to know which event has arrived.</p>
</div>
</li>
<li>
<p>Since the event state has a new name, you have to <strong>update</strong> the states <code>Prepare for Shipping</code> and <code>Forward to External Supplier</code> to point to it.</p>
<div class="ulist">
<ul>
<li>
<p>Search and <strong>update</strong> the corresponding transition declarations in this way: <code>transition: Order Shipped or Cancelled</code>.</p>
</li>
</ul>
</div>
</li>
<li>
<p><strong>Add</strong> the following switch state after the <code>Order Shipped or Cancelled</code> state:</p>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">- name: Is Shipped?
  type: switch
  dataConditions:
  - name: order cancelled
    condition: .cancel == true
    transition: Compensate Order
  defaultCondition:
    transition: Notify Customer</code></pre>
</div>
</div>
</li>
<li>
<p>After the previous state, <strong>Add</strong> an operation to handle the cancel event:</p>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">- name: Compensate Order
  type: operation
  actions:
  - name: printAction
    functionRef:
      refName: printMessage
      arguments:
        message: '"Compensate Order"'
  end:
    terminate: true
    compensate: true</code></pre>
</div>
</div>
</li>
<li>
<p>Locate the <code>Notify Customer</code> operation state and <strong>adjust</strong> the <code>end</code> property in this way:</p>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">  end:
    terminate: true</code></pre>
</div>
</div>
<div class="paragraph">
<p>This measure forces the workflow termination.</p>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>The following picture shows the result of the above procedure on the workflow diagram:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/05_cancel-event.png" alt="05 cancel event">
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="test-cancel"><a class="anchor" href="#test-cancel"></a>Test the cancelling event</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In this section, we are going to test that the workflow is able to resume the execution when two types of CloudEvents arrives:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>ShippingEventType</code></p>
</li>
<li>
<p><code>CancelEventType</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Deploy</strong> the  workflow latest updates:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>Select</strong> <code>Try on OpenShift</code> button and then <code>Upload "<strong>order</strong>" to Dev Mode</code>.</p>
<div class="imageblock">
<div class="content">
<img src="_images/02_upload.png" alt="upload">
</div>
</div>
</li>
<li>
<p>Wait for the confirmation message and <strong>select</strong> <code>Go to Serverless Workflow Dev UI ↗</code> to open the <em>Dev UI</em> in a new browser tab.</p>
<div class="imageblock">
<div class="content">
<img src="_images/02_devui.png" alt="Dev UI">
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>Start a new workflow instance:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>Open</strong> the <code>Workflow Definitions</code> page.</p>
</li>
<li>
<p>In workflow list, <strong>click</strong> on the event icon:</p>
<div class="imageblock">
<div class="content">
<img src="_images/04_cloud-event.png" alt="cloud event button">
</div>
</div>
</li>
<li>
<p><strong>Fill in</strong> the form with the following values:</p>
<div class="ulist">
<ul>
<li>
<p><strong>Event Type</strong> : <code>OrderEventType</code></p>
</li>
<li>
<p><strong>Event Custom Headers</strong> : <code>ce-orderid = 1002</code></p>
</li>
<li>
<p><strong>Event Data</strong> : <code>{"orderId": "1002", "item": "1111"}</code></p>
</li>
</ul>
</div>
</li>
<li>
<p><strong>Click</strong> <code>Trigger</code></p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Repeat the previous step to start a second workflow instance with <code>ce-orderid = 1003</code>.</p>
</div>
<div class="paragraph">
<p>Inject other two CloudEvents:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>First event will test the happy path:</p>
<div class="ulist">
<ul>
<li>
<p><strong>Event Type</strong> : <code>ShippingEventType</code></p>
</li>
<li>
<p><strong>Event Custom Headers</strong> : <code>ce-orderid = 1002</code></p>
</li>
</ul>
</div>
</li>
<li>
<p>Second event will test the cancellation path:</p>
<div class="ulist">
<ul>
<li>
<p><strong>Event Type</strong> : <code>CancelEventType</code></p>
</li>
<li>
<p><strong>Event Custom Headers</strong> : <code>ce-orderid = 1003</code></p>
</li>
</ul>
</div>
</li>
</ol>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Even if you trigger the compensation no compensation activity is defined, so at this stage of the exercise you can only look for the <code>Compensate Order</code> string in the logs.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="compensation-activities"><a class="anchor" href="#compensation-activities"></a>Compensation Activities Sprint</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In this section, you will add two compensation activities for <code>Prepare for Shipping</code> and  <code>Forward to External Supplier</code>.</p>
</div>
<div class="paragraph">
<p>Afterward, you will check that the runtime will call them when compensation is triggered by the cancel event.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Compensation activities are <strong>operation states</strong>, they could be placed anywhere in the <code>state</code> array. However, we suggest to place the definition nearby the corresponding primary state so it&#8217;s easier to orientate.
</td>
</tr>
</table>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Locate <code>Prepare for Shipping</code> and <strong>append</strong> right afterward:</p>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">- name: Restore Inventory
  type: operation
  usedForCompensation: true
  actions:
  - name: printAction
    functionRef:
      refName: printMessage
      arguments:
        message: Restore Inventory</code></pre>
</div>
</div>
</li>
<li>
<p>Inside <code>Prepare for Shipping</code> <strong>append</strong> the following property:</p>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">  compensatedBy: Restore Inventory</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the workflow diagram you should see the two states linked by a yellow dotted line:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/restore-inventory.png" alt="restore inventory">
</div>
</div>
</li>
<li>
<p>Locate <code>Forward to External Supplier</code> and <strong>append</strong> right afterward:</p>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">- name: Cancel Supplier Order
  type: operation
  usedForCompensation: true
  actions:
  - name: cancelOrder
    functionRef:
      refName: cancelOrder
      arguments:
        supplier-id: sup-01
        content: '.orderId'</code></pre>
</div>
</div>
</li>
<li>
<p>Inside <code>Forward to External Supplier</code> <strong>add</strong> the following property:</p>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">  compensatedBy: Cancel Supplier Order</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>In the workflow diagram you should see the following situation:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/compensation-activities.png" alt="compensation activities">
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="test-compensation"><a class="anchor" href="#test-compensation"></a>Testing the compensation</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Compensation comes in action when the workflow instance receives the cancel event: repeat the test procedure above.</p>
</div>
<div class="paragraph">
<p>In the workflow details page, you can see that the corresponding compensation state is triggered as shown in the following picture:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/05_compensated.png" alt="05 compensated">
</div>
</div>
<div class="paragraph">
<p><strong>CONGRATULATION!!!</strong> Your Serverless Workflow compensates wisely!</p>
</div>
</div>
</div>
<nav class="pagination">
  <span class="prev"><a href="04-longrunning.html" class="query-params-link">4. Long Running Workflows</a></span>
</nav>
</article>
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
  </div>
</main>
</div>
<footer class="footer">
  <a class="rhd-logo" href="https://developers.redhat.com" target="_blank"></div>
</footer>
<script src="../../_/js/vendor/clipboard.js"></script>
<script src="../../_/js/site.js"></script>
<script async src="../../_/js/vendor/highlight.js"></script>
  </body>
</html>
